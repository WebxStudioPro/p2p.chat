<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Global Random Chat</title>
    
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/gun/gun.js"></script>

    <style>
        * { box-sizing: border-box; }
        body { font-family: sans-serif; background: #121212; color: #fff; margin: 0; display: flex; flex-direction: column; height: 100vh; }
        #header { padding: 15px; background: #1f1f1f; text-align: center; border-bottom: 2px solid #00ff88; box-shadow: 0 4px 6px rgba(0,0,0,0.3); }
        h2 { margin: 0; font-size: 20px; color: #00ff88; }
        #status { font-size: 12px; color: #aaa; margin-top: 5px; }
        #chat-box { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px; background: #000; }
        .msg { padding: 10px 15px; border-radius: 20px; max-width: 85%; word-wrap: break-word; font-size: 15px; }
        .mine { background: #00ff88; color: #000; align-self: flex-end; border-bottom-right-radius: 2px; }
        .stranger { background: #333; color: #fff; align-self: flex-start; border-bottom-left-radius: 2px; }
        #controls { padding: 10px; display: none; gap: 8px; background: #1f1f1f; }
        input { flex: 1; padding: 12px; border-radius: 20px; border: none; background: #333; color: white; outline: none; font-size: 15px; }
        button { padding: 12px 20px; border-radius: 20px; background: #00ff88; color: black; border: none; font-weight: bold; font-size: 14px; }
        #findBtn { margin: 20px auto; display: block; padding: 15px 30px; font-size: 16px; width: 80%; max-width: 300px; border-radius: 30px; }
        .system-msg { text-align: center; color: #888; font-size: 12px; margin: 10px 0; }
    </style>
</head>
<body>

    <div id="header">
        <h2>Global Chat (No Limits)</h2>
        <div id="status">Connecting to Global Network...</div>
    </div>

    <div id="chat-box">
        <div class="system-msg">Welcome! Press the button to find a stranger.</div>
    </div>
    
    <button id="findBtn" onclick="findStranger()">üîç FIND STRANGER</button>

    <div id="controls">
        <input type="text" id="msgInput" placeholder="Type message..." onkeypress="handleEnter(event)">
        <button onclick="sendMessage()">SEND</button>
    </div>

    <script>
        // UI Elements
        const statusEl = document.getElementById('status');
        const chatBox = document.getElementById('chat-box');
        const controls = document.getElementById('controls');
        const findBtn = document.getElementById('findBtn');
        const msgInput = document.getElementById('msgInput');

        // --- CORE ARCHITECTURE ---
        let peer = null;        // Call Engine
        let myPeerId = null;    // Mera global mobile ID
        let currentChat = null; // Connection object
        let searching = false;

        // 1. Zinda Gun.js Relays (Ye dead nahi hain)
        const gun = Gun({
            peers: [
                'https://relay.peer.ooo/gun',
                'https://peer.wallie.io/gun'
            ],
            localStorage: false // Phone ki memory bachane ke liye
        });

        // 2. Initialize PeerJS (Auto STUN servers for Mobile Networks)
        function initPeer() {
            peer = new Peer({
                config: {
                    'iceServers': [
                        { urls: 'stun:stun.l.google.com:19302' }, // Google STUN for Jio/Airtel
                        { urls: 'stun:global.stun.twilio.com:3478' } // Backup STUN
                    ]
                }
            });

            peer.on('open', (id) => {
                myPeerId = id;
                statusEl.innerText = "Network Ready! (Your ID hidden securely)";
                statusEl.style.color = "#00ff88";
            });

            // Koi dusra stranger mujhe connect kare toh:
            peer.on('connection', (conn) => {
                if(searching) {
                    setupChat(conn);
                } else {
                    conn.close(); // Agar main chat me hu, toh reject kar do
                }
            });
        }

        // App start hote hi Peer engine chalu karo
        initPeer();

        // 3. MATCHMAKING LOGIC (The Lobby)
        function findStranger() {
            if (!myPeerId) return alert("Please wait, connecting to network...");
            
            searching = true;
            findBtn.style.display = 'none';
            statusEl.innerText = "Scanning the globe for strangers...";
            statusEl.style.color = "#ffaa00";
            chatBox.innerHTML = '<div class="system-msg">Searching...</div>';
            controls.style.display = 'none';

            const lobby = gun.get('global-chat-lobby-v2');

            // Lobby check karo
            lobby.once((data) => {
                const now = Date.now();
                
                if (data && data.waitingId && data.waitingId !== myPeerId && (now - data.time < 15000)) {
                    // STRANGER MIL GAYA! (Lobby me koi 15 sec se wait kar raha tha)
                    const strangerId = data.waitingId;
                    lobby.put({ waitingId: null, time: 0 }); // Lobby saaf karo
                    
                    statusEl.innerText = "Stranger Found! Connecting...";
                    
                    // PeerJS se direct connect maro
                    const conn = peer.connect(strangerId);
                    setupChat(conn);
                } else {
                    // LOBBY KHALI HAI, MAIN WAIT KARUNGA
                    lobby.put({ waitingId: myPeerId, time: now });
                    statusEl.innerText = "Waiting for someone to join...";
                    
                    // Ab 'peer.on("connection")' apne aap trigger hoga jab koi aayega
                }
            });
        }

        // 4. CHAT SETUP (Jab 2 log mil jaye)
        function setupChat(conn) {
            currentChat = conn;
            searching = false;

            conn.on('open', () => {
                statusEl.innerText = "Connected! Say Hi üëã";
                statusEl.style.color = "#00ff88";
                controls.style.display = 'flex';
                chatBox.innerHTML = '<div class="system-msg">You are now chatting with a random stranger.</div>';
            });

            // Message Receive karna
            conn.on('data', (data) => {
                displayMsg(data, 'stranger');
            });

            // Agar stranger disconnect ho jaye
            conn.on('close', () => {
                chatBox.innerHTML += '<div class="system-msg">Stranger has disconnected.</div>';
                endChat();
            });
        }

        // 5. SEND & DISPLAY MESSAGES
        function sendMessage() {
            const text = msgInput.value.trim();
            if (!text || !currentChat) return;

            // Direct mobile to mobile send (No server in between)
            currentChat.send(text);
            displayMsg(text, 'mine');
            msgInput.value = '';
        }

        function displayMsg(text, senderType) {
            const div = document.createElement('div');
            div.className = 'msg ' + senderType;
            div.innerText = text;
            chatBox.appendChild(div);
            chatBox.scrollTop = chatBox.scrollHeight; // Auto scroll
        }

        function handleEnter(e) {
            if (e.key === 'Enter') sendMessage();
        }

        function endChat() {
            if(currentChat) currentChat.close();
            controls.style.display = 'none';
            findBtn.style.display = 'block';
            findBtn.innerText = "üîç FIND NEW STRANGER";
            statusEl.innerText = "Disconnected.";
            statusEl.style.color = "red";
            currentChat = null;
        }
    </script>
</body>
</html>
