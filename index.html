<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <meta name="google-site-verification" content="87zIiOu8V4ybkIjdxacQm0x9CX2RwrOvYJRU8v_ZYp4" />
    <title>Random Chat - Online Peer to Peer Stranger Chat</title>
    <meta name="description" content="Join the fastest online random chat. Connect with strangers instantly on our secure, anonymous, peer to peer chat platform. Start your chat with stranger now.">
    <meta name="keywords" content="random chat, peer to peer chat, online chat, stranger chat, chat with stranger, instant chat, free anonymous chat">
    <meta name="robots" content="index, follow">
    <link rel="icon" type="image/png" href="favicon.png">
    
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>

    <style>
        * { box-sizing: border-box; font-family: 'Segoe UI', Tahoma, sans-serif; margin: 0; }
        
        body { background-color: #0d1117; color: #c9d1d9; display: flex; flex-direction: column; height: 100vh; height: 100dvh; overflow: hidden; }
        
        /* üî• THE SAFETY SPACER: Keeps UI safely below the Top Ad üî• */
        #ad-spacer {
            width: 100%;
            height: 85px; 
            flex-shrink: 0;
            background: transparent;
        }

        #header { padding: 15px; background: rgba(22, 27, 34, 0.95); backdrop-filter: blur(5px); text-align: center; border-bottom: 1px solid #30363d; box-shadow: 0 4px 15px rgba(0,0,0,0.4); z-index: 10; min-height: 70px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; transition: all 0.3s ease;}
        
        #default-header { width: 100%; }
        #default-header h2 { color: #58a6ff; font-size: 22px; text-transform: uppercase; letter-spacing: 2px; font-weight: 800; text-shadow: 0 0 10px rgba(88,166,255,0.3); margin-bottom: 2px;}
        #status-bar { font-size: 13px; color: #8b949e; margin-top: 5px; font-weight: bold; letter-spacing: 0.5px;}
        
        #chat-header { display: none; width: 100%; align-items: center; justify-content: flex-start; gap: 12px; padding: 0 10px; }
        .avatar-circle { width: 42px; height: 42px; background: linear-gradient(135deg, #30363d 0%, #161b22 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.4); border: 1px solid #484f58;}
        .stranger-info-box { text-align: left; display: flex; flex-direction: column; }
        #top-stranger-name { font-size: 16px; font-weight: bold; color: white; letter-spacing: 0.5px;}
        
        .badge-container { display: flex; align-items: center; gap: 8px; margin-top: 3px; }
        #top-stranger-gender { font-size: 10px; font-weight: bold; padding: 3px 8px; border-radius: 12px; display: inline-block; text-transform: uppercase; letter-spacing: 0.5px;}
        .gender-male { background: #1f6feb; color: white; box-shadow: 0 0 8px rgba(31, 111, 235, 0.4);}
        .gender-female { background: #FF1493; color: white; box-shadow: 0 0 8px rgba(255, 20, 147, 0.4);}
        .gender-other { background: #8250df; color: white; box-shadow: 0 0 8px rgba(130, 80, 223, 0.4);}
        
        #typing-indicator { font-size: 12px; color: #3fb950; font-weight: bold; display: none; font-style: italic; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { opacity: 0.5; } 50% { opacity: 1; } 100% { opacity: 0.5; } }
        
        #setup-container { 
            flex: 1; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            padding: 20px; 
            background: radial-gradient(circle at center, #161b22 0%, #0d1117 100%);
            overflow-y: auto; 
        }
        
        .setup-box { 
            width: 100%;
            max-width: 420px;
            background: rgba(22, 27, 34, 0.6); 
            backdrop-filter: blur(12px);
            padding: 35px 25px; 
            border-radius: 24px; 
            border: 1px solid rgba(255,255,255,0.08); 
            box-shadow: 0 25px 50px rgba(0,0,0,0.5), inset 0 0 0 1px rgba(255,255,255,0.02); 
            margin-top: 1vh;
            flex-shrink: 0;
        }
        .setup-box h3 { color: white; text-align: center; margin-bottom: 30px; font-size: 22px; letter-spacing: 1px; font-weight: 700;}
        .input-group { margin-bottom: 22px; }
        .input-group label { display: block; color: #8b949e; margin-bottom: 8px; font-size: 12px; text-transform: uppercase; letter-spacing: 1px; font-weight: 700;}
        
        .profile-input { 
            width: 100%; 
            padding: 15px; 
            border-radius: 12px; 
            border: 1px solid #30363d; 
            background: #0d1117; 
            color: white; 
            outline: none; 
            font-size: 15px; 
            transition: all 0.3s ease;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.2);
        }
        .profile-input:focus { 
            border-color: #58a6ff; 
            box-shadow: 0 0 0 3px rgba(88, 166, 255, 0.2), inset 0 2px 4px rgba(0,0,0,0.2); 
        }
        
        .terms-group { display: flex; align-items: flex-start; gap: 12px; margin-top: 10px; margin-bottom: 25px; background: rgba(0,0,0,0.2); padding: 12px; border-radius: 10px;}
        .terms-group input[type="checkbox"] { width: 20px; height: 20px; margin-top: 1px; accent-color: #58a6ff; cursor: pointer;}
        .terms-group label { color: #8b949e; font-size: 12px; line-height: 1.5; text-transform: none; letter-spacing: normal; font-weight: normal;}
        .terms-link { color: #58a6ff; text-decoration: underline; cursor: pointer; font-weight: bold;}
        
        #save-profile-btn { 
            width: 100%; 
            padding: 16px; 
            border-radius: 12px; 
            background: linear-gradient(135deg, #2ea043 0%, #238636 100%); 
            color: white; 
            border: none; 
            font-weight: 800; 
            font-size: 16px; 
            transition: all 0.2s ease; 
            cursor: pointer; 
            text-transform: uppercase; 
            letter-spacing: 2px;
            box-shadow: 0 8px 20px rgba(35, 134, 54, 0.3);
        }
        #save-profile-btn:active { background: #2ea043; transform: scale(0.97); box-shadow: 0 4px 10px rgba(35, 134, 54, 0.4);}
        
        /* SEO ARTICLE (UNTOUCHED) */
        .seo-article {
            width: 100%;
            max-width: 700px;
            margin-top: 40px;
            margin-bottom: 20px;
            padding: 20px;
            color: #8b949e;
            flex-shrink: 0;
            text-align: left;
        }
        .seo-article h1, .seo-article h2 { color: #c9d1d9; font-size: 18px; margin-bottom: 12px; font-weight: bold;}
        .seo-article h3 { color: #c9d1d9; font-size: 15px; margin-top: 20px; margin-bottom: 8px;}
        .seo-article p { font-size: 13px; line-height: 1.6; margin-bottom: 15px;}
        .seo-article strong { color: #58a6ff; font-weight: normal;}

        #chat-window { flex: 1; overflow-y: auto; padding: 20px 15px; display: none; flex-direction: column; gap: 12px; scroll-behavior: smooth;}
        .message { padding: 12px 16px; border-radius: 18px; max-width: 85%; font-size: 15px; word-wrap: break-word; box-shadow: 0 2px 5px rgba(0,0,0,0.15); position: relative; line-height: 1.4;}
        .my-message { background: #238636; color: white; align-self: flex-end; border-bottom-right-radius: 4px; }
        .stranger-message { background: #21262d; color: #c9d1d9; border: 1px solid #30363d; align-self: flex-start; border-bottom-left-radius: 4px; }
        
        .chat-img { max-width: 100%; border-radius: 12px; margin-top: 5px; display: block; }
        .chat-audio { max-width: 220px; height: 40px; margin-top: 5px; outline: none; border-radius: 20px; }
        
        .system-message { text-align: center; color: #8b949e; font-size: 12px; margin: 15px 0; font-style: italic; background: rgba(33, 38, 45, 0.8); padding: 8px 15px; border-radius: 12px; align-self: center; width: fit-content; border: 1px solid #30363d;}

        #action-area { padding: 12px; background: #161b22; border-top: 1px solid #30363d; display: none; flex-shrink: 0; padding-bottom: max(12px, env(safe-area-inset-bottom)); }
        #find-btn { width: 100%; padding: 16px; border-radius: 12px; background: linear-gradient(135deg, #388bfd 0%, #1f6feb 100%); color: white; border: none; font-weight: 800; font-size: 16px; transition: 0.2s; text-transform: uppercase; cursor: pointer; letter-spacing: 1.5px; box-shadow: 0 8px 20px rgba(31, 111, 235, 0.3);}
        #find-btn:active { transform: scale(0.97); box-shadow: 0 4px 10px rgba(31, 111, 235, 0.4);}
        
        #input-container { display: none; gap: 8px; align-items: center; width: 100%; }
        
        .media-btn { background: #21262d; color: white; border: 1px solid #30363d; border-radius: 50%; width: 44px; height: 44px; display: flex; align-items: center; justify-content: center; font-size: 18px; flex-shrink: 0; cursor: pointer; transition: 0.2s; box-shadow: 0 2px 6px rgba(0,0,0,0.2);}
        .media-btn:active { background: #30363d; transform: scale(0.95); }
        .mic-recording { background: #da3633 !important; border-color: #da3633 !important; animation: pulse 1s infinite; }
        
        #msg-input { flex: 1; padding: 14px 18px; border-radius: 24px; border: 1px solid #30363d; background: #0d1117; color: white; outline: none; font-size: 15px; transition: border 0.2s; min-width: 0; box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);}
        #msg-input:focus { border-color: #8b949e; }
        
        #send-btn { padding: 12px 20px; border-radius: 24px; background: #238636; color: white; border: none; font-weight: bold; cursor: pointer; flex-shrink: 0; font-size: 14px;}
        #send-btn:active { background: #2ea043; }
        
        #disconnect-btn { padding: 0; border-radius: 50%; background: #da3633; color: white; border: none; font-weight: bold; width: 44px; height: 44px; display: flex; align-items: center; justify-content: center; font-size: 18px; flex-shrink: 0; cursor: pointer; box-shadow: 0 2px 6px rgba(218, 54, 51, 0.3);}
        #disconnect-btn:active { background: #f85149; transform: scale(0.95);}

        #recording-timer-display { flex: 1; text-align: center; color: #da3633; font-weight: bold; font-family: monospace; font-size: 16px; letter-spacing: 1px; animation: pulse 1s infinite; }

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.85); backdrop-filter: blur(6px); z-index: 100; display: none; align-items: center; justify-content: center; }
        .modal-box { background: #161b22; width: 90%; max-width: 420px; border-radius: 20px; padding: 30px; border: 1px solid #30363d; box-shadow: 0 25px 50px rgba(0,0,0,0.6); animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); display: flex; flex-direction: column;}
        .modal-box h3 { color: white; font-size: 20px; margin-bottom: 15px; text-align: center; font-weight: 800;}
        
        .tnc-content { background: #0d1117; padding: 18px; border-radius: 12px; border: 1px solid #30363d; color: #8b949e; font-size: 13px; line-height: 1.6; max-height: 280px; overflow-y: auto; margin-bottom: 25px;}
        .tnc-content h4 { color: #58a6ff; margin-top: 12px; margin-bottom: 6px; font-size: 14px; text-transform: uppercase; letter-spacing: 0.5px;}
        .tnc-content h4.warning { color: #ff8182; }
        
        .modal-buttons { display: flex; gap: 15px; }
        .btn-cancel { flex: 1; padding: 14px; border-radius: 12px; background: #21262d; color: white; border: 1px solid #30363d; font-weight: bold; font-size: 15px; cursor: pointer; transition: 0.2s;}
        .btn-cancel:active { background: #30363d; }
        .btn-leave { flex: 1; padding: 14px; border-radius: 12px; background: #da3633; color: white; border: none; font-weight: bold; font-size: 15px; cursor: pointer; transition: 0.2s; box-shadow: 0 4px 12px rgba(218, 54, 51, 0.3);}
        .btn-leave:active { background: #f85149; }
        .btn-full { width: 100%; background: linear-gradient(135deg, #388bfd 0%, #1f6feb 100%); border: none; color: white; padding: 16px; border-radius: 12px; font-weight: bold; cursor: pointer; font-size: 16px; letter-spacing: 1px;}
        
        @keyframes popIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    </style>
</head>
<body>

    <div id="ad-spacer"></div>

    <div id="header">
        <div id="default-header">
            <h2>Peer to Peer Chat ‚ö°</h2>
            <div id="status-bar">Identity Setup</div>
        </div>
        
        <div id="chat-header">
            <div class="avatar-circle">üë§</div>
            <div class="stranger-info-box">
                <span id="top-stranger-name">Searching...</span>
                <div class="badge-container">
                    <span id="top-stranger-gender" class="gender-male">Unknown</span>
                    <span id="typing-indicator">typing...</span>
                </div>
            </div>
        </div>
    </div>

    <div id="exit-modal-overlay" class="modal-overlay">
        <div class="modal-box" style="text-align: center;">
            <h3>Exit Secure Chat?</h3>
            <p style="color: #8b949e; font-size: 14px; margin-bottom: 25px;">Are you sure you want to disconnect? This P2P session will be destroyed forever.</p>
            <div class="modal-buttons">
                <button class="btn-cancel" onclick="closeModal()">Cancel</button>
                <button class="btn-leave" onclick="confirmExit()">Disconnect</button>
            </div>
        </div>
    </div>

    <div id="tnc-modal-overlay" class="modal-overlay">
        <div class="modal-box">
            <h3>Platform Rules & T&C</h3>
            <div class="tnc-content">
                <h4>1. Acceptance & Age Restriction</h4>
                You must be exactly 18 years or older to access this network. By proceeding, you legally verify your age.
                
                <h4>2. Peer-to-Peer Architecture</h4>
                This platform uses direct WebRTC technology. <b>We do NOT monitor, host, or store your text, audio, or images on any server.</b>
                
                <h4>3. Zero Developer Liability</h4>
                Because connections are direct between users, the platform developers are 100% indemnified and cannot be held liable for any user-generated actions or disputes.
                
                <h4 class="warning">4. Strict Zero-Tolerance Policy</h4>
                <b>PROHIBITED:</b> Any form of harassment, abuse, blackmail, or sharing of illegal explicit content is strictly forbidden. Users reported or flagged by the network logic for malicious behavior will face an <b>immediate and permanent IP/Device ban</b> without warning.
            </div>
            <button class="btn-full" onclick="closeTncModal()">I Agree & Understand</button>
        </div>
    </div>

    <div id="setup-container">
        <div class="setup-box">
            <h3>Create Your Profile</h3>
            <div class="input-group">
                <label>Nickname</label>
                <input type="text" id="user-name" class="profile-input" placeholder="Enter a display name..." maxlength="15">
            </div>
            <div class="input-group">
                <label>Identity / Gender</label>
                <select id="user-gender" class="profile-input">
                    <option value="Male">Male</option>
                    <option value="Female">Female</option>
                    <option value="Other">Other</option>
                </select>
            </div>
            
            <div class="terms-group">
                <input type="checkbox" id="terms-checkbox">
                <label>I am 18+ and accept the <span class="terms-link" onclick="showTncModal()">Rules & Policy</span>. I understand violations result in a permanent network ban.</label>
            </div>

            <button id="save-profile-btn" onclick="saveProfile()">Enter Lobby</button>
        </div>

        <article class="seo-article">
            <h1>Experience the Best Random Chat Online</h1>
            <p>Welcome to the most advanced <strong>peer to peer chat</strong> platform. If you are looking to <strong>chat with strangers</strong> securely and instantly, you have found the right place. Our <strong>online chat</strong> engine uses cutting-edge WebRTC technology to connect you directly with users worldwide, ensuring a seamless and fully anonymous experience.</p>
            
            <h3>Why is our Stranger Chat 100% Secure?</h3>
            <p>Unlike traditional chat apps, our <strong>anonymous chat</strong> system does not store your private messages, images, or audio voice notes on any central server. By utilizing a direct P2P network, your data travels strictly between you and the stranger. This means your private <strong>chat with stranger</strong> sessions remain completely confidential and secure.</p>
            
            <h3>Lightning Fast Matchmaking</h3>
            <p>Tired of waiting for connections? Our unique high-frequency network radar scans hundreds of global slots to find you a <strong>stranger chat</strong> partner in milliseconds. Whether you want to make new friends, practice a foreign language, or simply enjoy a quick <strong>random chat</strong>, our server-less engine ensures zero lag and instant connectivity.</p>
        </article>
    </div>

    <div id="chat-window">
        <div class="system-message">Engine Online. Connections are end-to-end encrypted.</div>
    </div>
    
    <div id="action-area">
        <button id="find-btn" onclick="initiateMatchmaking()">CONNECT TO STRANGER</button>
        <div id="input-container">
            <button id="disconnect-btn" onclick="showExitModal()">‚úñ</button>
            
            <button class="media-btn" id="photo-btn" onclick="document.getElementById('image-input').click()">üì∑</button>
            <input type="file" id="image-input" accept="image/*" style="display: none;" onchange="handleImageSelection(event)">
            
            <button class="media-btn" id="mic-btn" onclick="startAudioRecordingUI()">üé§</button>

            <input type="text" id="msg-input" placeholder="Type a message..." oninput="handleTypingEvent()" onkeypress="handleKeypress(event)">
            <button id="send-btn" onclick="sendDataChannelMessage()">SEND</button>

            <button class="media-btn" id="cancel-audio-btn" style="display: none; background: #da3633; border-color: #da3633;" onclick="cancelAudioRecording()">üóëÔ∏è</button>
            <div id="recording-timer-display" style="display: none;">üî¥ 00:00</div>
            <button class="media-btn" id="send-audio-btn" style="display: none; background: #238636; border-color: #238636;" onclick="sendAudioRecording()">‚úÖ</button>
        </div>
    </div>

    <script>
        const UI = {
            defaultHeader: document.getElementById('default-header'),
            chatHeader: document.getElementById('chat-header'),
            topName: document.getElementById('top-stranger-name'),
            topGender: document.getElementById('top-stranger-gender'),
            typingIndicator: document.getElementById('typing-indicator'),
            status: document.getElementById('status-bar'),
            setupContainer: document.getElementById('setup-container'),
            chatBox: document.getElementById('chat-window'),
            actionArea: document.getElementById('action-area'),
            findBtn: document.getElementById('find-btn'),
            inputArea: document.getElementById('input-container'),
            msgInput: document.getElementById('msg-input'),
            userNameInput: document.getElementById('user-name'),
            userGenderInput: document.getElementById('user-gender'),
            exitModal: document.getElementById('exit-modal-overlay'),
            tncModal: document.getElementById('tnc-modal-overlay'),
            termsCheckbox: document.getElementById('terms-checkbox'),
            micBtn: document.getElementById('mic-btn')
        };

        function showExitModal() { UI.exitModal.style.display = 'flex'; }
        function closeModal() { UI.exitModal.style.display = 'none'; }
        function confirmExit() { closeModal(); terminateSession(); }
        
        function showTncModal() { UI.tncModal.style.display = 'flex'; }
        function closeTncModal() { UI.tncModal.style.display = 'none'; }

        let myProfile = { name: 'Stranger', gender: 'Unknown' };
        
        let currentUserState = 'SETUP'; 
        
        function saveProfile() {
            if (!UI.termsCheckbox.checked) {
                alert("‚ö†Ô∏è You must agree to the Platform Rules and confirm you are 18+ to enter.");
                return; 
            }

            let nameVal = UI.userNameInput.value.trim();
            if(nameVal === '') nameVal = 'Stranger';
            
            myProfile.name = nameVal;
            myProfile.gender = UI.userGenderInput.value;

            UI.setupContainer.style.display = 'none';
            UI.chatBox.style.display = 'flex';
            UI.actionArea.style.display = 'flex'; 
            
            currentUserState = 'LOBBY'; 
            connectSignalingServer();
        }

        let typingTimer = null;
        let amITyping = false;

        let mediaRecorder;
        let audioChunks = [];
        let recordTimerInterval = null;
        let recordSeconds = 0;

        // üî• ENGINE CODE: 100% UNTOUCHED üî•
        const TOTAL_SLOTS = 200; 
        
        let mySessionId = 'peer_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        let PRIVATE_TOPIC = `krish_v17_private_${mySessionId}`;
        
        let all200Slots = [];
        for(let i = 1; i <= TOTAL_SLOTS; i++) {
            all200Slots.push(`krish_v17_slot_${i}`);
        }

        let myPublishSlot = ''; 
        let magnetPulseTimer = null; 
        
        let mqttClient = null;
        let peerConnection = null;
        let dataChannel = null;
        let isSearching = false;

        const rtcConfiguration = {
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' },
                { urls: 'stun:stun.cloudflare.com:3478' },
                { urls: 'turn:openrelay.metered.ca:80', username: 'openrelayproject', credential: 'openrelayproject' },
                { urls: 'turn:openrelay.metered.ca:443', username: 'openrelayproject', credential: 'openrelayproject' }
            ]
        };

        function connectSignalingServer() {
            updateStatus('Connecting to network...', '#8b949e');
            mqttClient = mqtt.connect('wss://broker.emqx.io:8084/mqtt');

            mqttClient.on('connect', () => {
                updateStatus(`Welcome, ${myProfile.name}. Ready to connect.`, '#3fb950');
                mqttClient.subscribe(PRIVATE_TOPIC); 
            });

            mqttClient.on('message', async (topic, message) => {
                const payload = JSON.parse(message.toString());
                handleSignalingData(payload);
            });
            
            mqttClient.on('error', (err) => {
                updateStatus('Network Error. Reconnecting...', '#da3633');
            });
        }

        function initiateMatchmaking() {
            if (!mqttClient || !mqttClient.connected) {
                alert("Server is still connecting. Please wait a second.");
                return;
            }

            isSearching = true;
            currentUserState = 'SEARCHING'; 
            
            UI.findBtn.style.display = 'none';
            UI.chatBox.innerHTML = ''; 
            
            updateStatus('Searching global network for a match...', '#d29922');
            printSystemMessage('Deploying secure radar. Looking for strangers in the grid...');

            mqttClient.subscribe(all200Slots);
            
            const randomSlotNum = Math.floor(Math.random() * TOTAL_SLOTS) + 1;
            myPublishSlot = `krish_v17_slot_${randomSlotNum}`;

            const pulse = JSON.stringify({ type: 'magnet_pulse', senderId: mySessionId });
            mqttClient.publish(myPublishSlot, pulse);

            clearInterval(magnetPulseTimer);
            magnetPulseTimer = setInterval(() => {
                if (isSearching) {
                    mqttClient.publish(myPublishSlot, pulse);
                }
            }, 1500);
        }

        function lockEngineAndHideEars() {
            isSearching = false;
            clearInterval(magnetPulseTimer);
            mqttClient.unsubscribe(all200Slots);
        }

        async function handleSignalingData(payload) {
            if (payload.type === 'magnet_pulse' && payload.senderId !== mySessionId && isSearching) {
                if (mySessionId > payload.senderId) {
                    lockEngineAndHideEars();
                    updateStatus('Target acquired! Securing private link...', '#58a6ff');
                    
                    sendSignalingPayload(payload.senderId, { type: 'magnet_pull', senderId: mySessionId });
                    
                    initializeWebRTC(payload.senderId);
                    const offer = await peerConnection.createOffer();
                    await peerConnection.setLocalDescription(offer);
                    sendSignalingPayload(payload.senderId, { type: 'rtc_offer', offer: offer, senderId: mySessionId });
                }
            }

            if (payload.type === 'magnet_pull' && payload.senderId !== mySessionId && isSearching) {
                lockEngineAndHideEars();
                updateStatus('Match found! Synchronizing connection...', '#58a6ff');
                initializeWebRTC(payload.senderId);
            }

            if (payload.type === 'rtc_offer' && payload.senderId !== mySessionId) {
                if (isSearching) { lockEngineAndHideEars(); }
                if (!peerConnection) { initializeWebRTC(payload.senderId); }
                
                updateStatus('Securing Connection...', '#58a6ff');
                await peerConnection.setRemoteDescription(new RTCSessionDescription(payload.offer));
                
                const answer = await peerConnection.createAnswer();
                await peerConnection.setLocalDescription(answer);
                sendSignalingPayload(payload.senderId, { type: 'rtc_answer', answer: answer, senderId: mySessionId });
            }

            if (payload.type === 'rtc_answer' && payload.senderId !== mySessionId) {
                await peerConnection.setRemoteDescription(new RTCSessionDescription(payload.answer));
            }

            if (payload.type === 'peer_busy') {
                terminateSession(false, "‚ö†Ô∏è Stranger got connected to someone else. Please click CONNECT TO STRANGER again.");
            }

            if (payload.type === 'ice_candidate' && payload.senderId !== mySessionId) {
                try { await peerConnection.addIceCandidate(new RTCIceCandidate(payload.candidate)); } 
                catch (e) { console.error('ICE Error', e); }
            }
        }

        function initializeWebRTC(targetPeerId) {
            if (peerConnection) peerConnection.close(); 
            peerConnection = new RTCPeerConnection(rtcConfiguration);

            dataChannel = peerConnection.createDataChannel('chat_channel');
            setupDataChannelListeners(dataChannel);

            peerConnection.ondatachannel = (event) => {
                dataChannel = event.channel;
                setupDataChannelListeners(dataChannel);
            };

            peerConnection.onicecandidate = (event) => {
                if (event.candidate) {
                    sendSignalingPayload(targetPeerId, { type: 'ice_candidate', candidate: event.candidate, senderId: mySessionId });
                }
            };

            peerConnection.oniceconnectionstatechange = () => {
                if (peerConnection.iceConnectionState === 'disconnected' || peerConnection.iceConnectionState === 'failed') {
                    terminateSession(true);
                }
            };
        }

        function sendSignalingPayload(targetId, payloadObj) {
            mqttClient.publish(`krish_v17_private_${targetId}`, JSON.stringify(payloadObj));
        }

        function setupDataChannelListeners(channel) {
            channel.onopen = () => {
                currentUserState = 'CHATTING'; 
                UI.inputArea.style.display = 'flex';
                const introPacket = JSON.stringify({ type: 'intro', profile: myProfile });
                dataChannel.send(introPacket);
            };

            channel.onmessage = (event) => { 
                try {
                    const data = JSON.parse(event.data);
                    
                    if (data.type === 'intro') {
                        UI.defaultHeader.style.display = 'none';
                        UI.chatHeader.style.display = 'flex';
                        UI.topName.innerText = data.profile.name;
                        UI.topGender.innerText = data.profile.gender;
                        
                        if(data.profile.gender === 'Female') {
                            UI.topGender.className = 'gender-female';
                        } else if(data.profile.gender === 'Other') {
                            UI.topGender.className = 'gender-other';
                        } else {
                            UI.topGender.className = 'gender-male';
                        }
                        
                        printSystemMessage(`You are chatting securely with ${data.profile.name}. Say Hi!`);
                    } 
                    else if (data.type === 'chat') {
                        renderMessage(data.content, 'stranger', 'text');
                        UI.typingIndicator.style.display = 'none'; 
                    }
                    else if (data.type === 'image') {
                        renderMessage(data.content, 'stranger', 'image');
                        UI.typingIndicator.style.display = 'none'; 
                    }
                    else if (data.type === 'audio') {
                        renderMessage(data.content, 'stranger', 'audio');
                        UI.typingIndicator.style.display = 'none'; 
                    }
                    else if (data.type === 'typing') {
                        if (data.status === true) {
                            UI.typingIndicator.style.display = 'inline-block';
                        } else {
                            UI.typingIndicator.style.display = 'none';
                        }
                    }
                } catch(e) {
                    renderMessage(event.data, 'stranger', 'text');
                }
            };

            channel.onclose = () => terminateSession(true);
        }

        function handleTypingEvent() {
            if (!dataChannel || dataChannel.readyState !== 'open') return;
            if (!amITyping) {
                amITyping = true;
                dataChannel.send(JSON.stringify({ type: 'typing', status: true }));
            }
            clearTimeout(typingTimer);
            typingTimer = setTimeout(() => {
                amITyping = false;
                dataChannel.send(JSON.stringify({ type: 'typing', status: false }));
            }, 1500);
        }

        function sendDataChannelMessage() {
            const text = UI.msgInput.value.trim();
            if (text === '' || !dataChannel || dataChannel.readyState !== 'open') return;

            const msgPacket = JSON.stringify({ type: 'chat', content: text, profile: myProfile });
            dataChannel.send(msgPacket);
            
            amITyping = false;
            clearTimeout(typingTimer);
            dataChannel.send(JSON.stringify({ type: 'typing', status: false }));

            renderMessage(text, 'mine', 'text');
            UI.msgInput.value = '';
        }

        function handleImageSelection(event) {
            const file = event.target.files[0];
            if (!file || !dataChannel || dataChannel.readyState !== 'open') return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.src = e.target.result;
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    const MAX_WIDTH = 500;
                    const scaleSize = MAX_WIDTH / img.width;
                    canvas.width = MAX_WIDTH;
                    canvas.height = img.height * scaleSize;
                    
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    
                    const base64Img = canvas.toDataURL('image/jpeg', 0.5);
                    dataChannel.send(JSON.stringify({ type: 'image', content: base64Img, profile: myProfile }));
                    renderMessage(base64Img, 'mine', 'image');
                }
            };
            reader.readAsDataURL(file);
        }

        async function startAudioRecordingUI() {
            if (!dataChannel || dataChannel.readyState !== 'open') return;
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];

                mediaRecorder.ondataavailable = event => {
                    audioChunks.push(event.data);
                };

                document.getElementById('photo-btn').style.display = 'none';
                document.getElementById('mic-btn').style.display = 'none';
                document.getElementById('msg-input').style.display = 'none';
                document.getElementById('send-btn').style.display = 'none';

                document.getElementById('cancel-audio-btn').style.display = 'flex';
                document.getElementById('recording-timer-display').style.display = 'block';
                document.getElementById('send-audio-btn').style.display = 'flex';

                recordSeconds = 0;
                document.getElementById('recording-timer-display').innerText = 'üî¥ 00:00';
                recordTimerInterval = setInterval(() => {
                    recordSeconds++;
                    let mins = Math.floor(recordSeconds / 60).toString().padStart(2, '0');
                    let secs = (recordSeconds % 60).toString().padStart(2, '0');
                    document.getElementById('recording-timer-display').innerText = `üî¥ ${mins}:${secs}`;
                }, 1000);

                mediaRecorder.start();
            } catch (err) {
                alert("Please allow Microphone access to send voice notes!");
            }
        }

        function cancelAudioRecording() {
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.onstop = null; 
                mediaRecorder.stop();
                mediaRecorder.stream.getTracks().forEach(track => track.stop());
            }
            resetAudioUI();
        }

        function sendAudioRecording() {
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.onstop = () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    const reader = new FileReader();
                    reader.readAsDataURL(audioBlob); 
                    reader.onloadend = () => {
                        const base64Audio = reader.result;
                        dataChannel.send(JSON.stringify({ type: 'audio', content: base64Audio, profile: myProfile }));
                        renderMessage(base64Audio, 'mine', 'audio');
                    };
                    mediaRecorder.stream.getTracks().forEach(track => track.stop());
                };
                mediaRecorder.stop();
            }
            resetAudioUI();
        }

        function resetAudioUI() {
            clearInterval(recordTimerInterval);
            
            document.getElementById('cancel-audio-btn').style.display = 'none';
            document.getElementById('recording-timer-display').style.display = 'none';
            document.getElementById('send-audio-btn').style.display = 'none';

            document.getElementById('photo-btn').style.display = 'flex';
            document.getElementById('mic-btn').style.display = 'flex';
            document.getElementById('msg-input').style.display = ''; 
            document.getElementById('send-btn').style.display = 'block';
        }

        function renderMessage(content, type, msgFormat = 'text') {
            const wrapper = document.createElement('div');
            wrapper.className = `message ${type === 'mine' ? 'my-message' : 'stranger-message'}`;
            
            if (msgFormat === 'text') {
                wrapper.innerText = content;
            } else if (msgFormat === 'image') {
                const img = document.createElement('img');
                img.src = content;
                img.className = 'chat-img';
                wrapper.appendChild(img);
            } else if (msgFormat === 'audio') {
                const audio = document.createElement('audio');
                audio.controls = true;
                audio.src = content;
                audio.className = 'chat-audio';
                wrapper.appendChild(audio);
            }
            
            UI.chatBox.appendChild(wrapper);
            UI.chatBox.scrollTop = UI.chatBox.scrollHeight;
        }

        function printSystemMessage(text) {
            const wrapper = document.createElement('div');
            wrapper.className = 'system-message';
            wrapper.innerText = text;
            UI.chatBox.appendChild(wrapper);
            UI.chatBox.scrollTop = UI.chatBox.scrollHeight;
        }

        function updateStatus(text, color) { UI.status.innerText = text; UI.status.style.color = color; }
        
        function handleKeypress(e) { 
            if (e.key === 'Enter') sendDataChannelMessage(); 
        }

        function terminateSession(isRemoteDisconnect = false, customMessage = null) {
            if (peerConnection) { peerConnection.close(); }
            peerConnection = null; 
            dataChannel = null; 
            
            lockEngineAndHideEars(); 
            clearTimeout(typingTimer);
            amITyping = false;
            
            cancelAudioRecording();
            
            currentUserState = 'LOBBY'; 

            UI.chatHeader.style.display = 'none';
            UI.typingIndicator.style.display = 'none';
            UI.defaultHeader.style.display = 'block';

            UI.inputArea.style.display = 'none';
            UI.findBtn.style.display = 'block';
            updateStatus('Disconnected.', '#da3633');
            
            UI.chatBox.innerHTML = ''; 
            
            if (customMessage) {
                printSystemMessage(customMessage);
            } else {
                printSystemMessage(isRemoteDisconnect ? 'Stranger has disconnected. Memory cleared.' : 'You left the chat. Memory cleared.');
            }
        }

        const adminSyncClient = mqtt.connect('wss://broker.emqx.io:8084/mqtt');
        
        adminSyncClient.on('connect', () => {
            setInterval(() => {
                let activeSlot = '0';
                if (currentUserState === 'SEARCHING' && myPublishSlot) {
                    activeSlot = myPublishSlot.split('_').pop();
                }
                
                const payload = {
                    id: mySessionId,
                    state: currentUserState,
                    slot: activeSlot
                };
                
                adminSyncClient.publish('krish_v17_admin_radar_sync', JSON.stringify(payload));
            }, 2000); 
        });
    </script>
    
    <script type="text/javascript" src="https://pl28713238.effectivegatecpm.com/41/29/39/41293924c20c7ebf57324ed041cb2eee.js" async></script>
</body>
</html>